<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả học tập | Learning Hub</title>
    <!-- Use Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7g0n7s2xU8W+c/qA8Nf6A2y7t6L/j8E5Jz3r2b+oW9s5/b4/F5A2zR8xV/K6l6zU1e+A9sQ3FjQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #chat-content::-webkit-scrollbar {
            width: 8px;
        }
        #chat-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .grade-A { background-color: #10B981; color: white; }
        .grade-B { background-color: #3B82F6; color: white; }
        .grade-C { background-color: #F59E0B; color: white; }
        .grade-D { background-color: #EF4444; color: white; }
        .grade-F { background-color: #6B7280; color: white; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="text-2xl font-bold text-blue-600">Learning Hub</div>
            <ul class="hidden md:flex space-x-6 md:space-x-8 lg:space-x-10">
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Trang chủ</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Giới thiệu</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Khóa học</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Lịch học</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Lịch thi</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Tin tức</a></li>
                <li><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">Liên hệ</a></li>
                <li><a href="#" id="logoutBtn" class="text-red-500 hover:text-red-700 transition-colors font-semibold">Đăng xuất</a></li>
            </ul>
            <div class="md:hidden">
                <button id="mobile-menu-btn" class="text-gray-600">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white px-4 pb-4">
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Trang chủ</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Giới thiệu</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Khóa học</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Lịch học</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Lịch thi</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Tin tức</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-blue-600">Liên hệ</a>
            <a href="#" class="block py-2 text-red-500 hover:text-red-700 font-semibold">Đăng xuất</a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Banner -->
        <section id="banner" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl shadow-lg p-8 text-center animate-fade-in">
            <h1 id="page-title" class="text-3xl lg:text-5xl font-extrabold leading-tight">Kết quả môn học</h1>
            <p id="page-subtitle" class="mt-2 text-lg">Thông tin chi tiết về điểm số của môn học.</p>
        </section>

        <!-- Main Content Section -->
        <section class="mt-8">
            <!-- Subject Details View -->
            <div id="subject-view" class="animate-fade-in">
                <button id="back-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors flex items-center mb-6">
                    <i class="fas fa-arrow-left mr-2"></i> Quay lại
                </button>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h3 id="subject-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-2"></h3>
                            <div id="subject-info" class="text-gray-600"></div>
                        </div>
                        <div id="subject-grade-badge" class="mt-4 md:mt-0 px-4 py-2 rounded-full text-white font-bold text-lg"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Scores Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full leading-normal mb-6">
                                <thead>
                                    <tr>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Loại điểm</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Điểm số</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Trọng số</th>
                                    </tr>
                                </thead>
                                <tbody id="subject-scores-table-body">
                                    <!-- Data will be populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Score Chart -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-gray-700 mb-4 text-center">Biểu đồ điểm thành phần</p>
                            <canvas id="score-chart" height="250"></canvas>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-gray-700">Điểm tổng kết:</p>
                            <p id="total-score" class="text-2xl font-bold text-teal-600 mt-1"></p>
                            <div class="mt-4">
                                <p class="font-semibold text-gray-700">Công thức tính điểm:</p>
                                <p id="score-formula" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-gray-700">Nhận xét của giảng viên:</p>
                            <p id="teacher-comment" class="text-gray-800 mt-1"></p>
                            <div class="mt-4 flex items-center">
                                <div class="w-10 h-10 rounded-full bg-teal-500 flex items-center justify-center text-white font-bold">
                                    <span id="teacher-avatar">GV</span>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-semibold" id="teacher-name"></p>
                                    <p class="text-xs text-gray-500">Giảng viên phụ trách</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Chatbot Widget and UI -->
    <div id="chatbot-icon" class="fixed bottom-6 right-6 z-50 bg-blue-600 text-white p-4 rounded-full shadow-lg cursor-pointer hover:scale-110 transition-transform">
        <i class="fas fa-robot text-2xl"></i>
    </div>
    <div id="chatbot-window" class="fixed bottom-20 right-6 w-80 h-96 bg-white rounded-lg shadow-2xl flex flex-col hidden z-50">
        <div class="p-4 bg-blue-600 text-white rounded-t-lg flex justify-between items-center">
            <h4 class="font-bold">AI Chatbot Hỗ trợ Học tập</h4>
            <button id="close-chat-btn" class="text-white hover:text-gray-200">&times;</button>
        </div>
        <div id="chat-content" class="flex-1 p-4 overflow-y-auto">
            <div class="text-center text-sm text-gray-500">Chào mừng bạn! Tôi có thể giúp gì cho bạn về điểm môn học?</div>
        </div>
        <form id="chat-form" class="p-4 border-t border-gray-200 flex">
            <input type="text" id="chat-input" class="flex-1 border-0 rounded-full bg-gray-100 px-4 py-2 focus:outline-none" placeholder="Nhập tin nhắn...">
            <button type="submit" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        // Simulated data to mimic backend API responses
        const gradeData = {
            'hk1-2024': {
                gpa: 3.50,
                cumulativeGpa: 3.45,
                rank: 'Giỏi',
                subjects: [
                    {
                        code: 'INT101', name: 'Nhập môn Lập trình', credits: 3, totalScore: 8.5, grade: 'A',
                        details: {
                            teacher: 'ThS. Nguyễn Văn A',
                            teacherShort: 'NVA',
                            scores: [
                                { name: 'Điểm chuyên cần', score: 9.0, weight: '10%' },
                                { name: 'Điểm giữa kỳ', score: 8.0, weight: '20%' },
                                { name: 'Điểm bài tập về nhà', score: 8.5, weight: '20%' },
                                { name: 'Điểm thực hành', score: 8.5, weight: '20%' },
                                { name: 'Điểm cuối kỳ', score: 9.0, weight: '30%' }
                            ],
                            comment: 'Sinh viên tích cực và có nền tảng tốt. Cần phát huy hơn nữa.',
                            formula: 'Điểm tổng kết = (Chuyên cần × 0.1) + (Giữa kỳ × 0.2) + (Bài tập × 0.2) + (Thực hành × 0.2) + (Cuối kỳ × 0.3)'
                        }
                    },
                    {
                        code: 'MAT101', name: 'Giải tích 1', credits: 4, totalScore: 7.2, grade: 'B+',
                        details: {
                            teacher: 'TS. Lê Thị B',
                            teacherShort: 'LTB',
                            scores: [
                                { name: 'Điểm chuyên cần', score: 8.0, weight: '10%' },
                                { name: 'Điểm giữa kỳ', score: 7.5, weight: '30%' },
                                { name: 'Điểm bài tập về nhà', score: 7.0, weight: '20%' },
                                { name: 'Điểm cuối kỳ', score: 7.0, weight: '40%' }
                            ],
                            comment: 'Kết quả khá tốt, cần ôn tập thêm phần giải phương trình.',
                            formula: 'Điểm tổng kết = (Chuyên cần × 0.1) + (Giữa kỳ × 0.3) + (Bài tập × 0.2) + (Cuối kỳ × 0.4)'
                        }
                    },
                    {
                        code: 'PHY101', name: 'Vật lý Đại cương', credits: 3, totalScore: 6.8, grade: 'B',
                        details: {
                            teacher: 'TS. Trần Văn C',
                            teacherShort: 'TVC',
                            scores: [
                                { name: 'Điểm chuyên cần', score: 8.5, weight: '10%' },
                                { name: 'Điểm giữa kỳ', score: 6.0, weight: '25%' },
                                { name: 'Điểm bài tập về nhà', score: 6.5, weight: '15%' },
                                { name: 'Điểm thực hành', score: 7.0, weight: '20%' },
                                { name: 'Điểm cuối kỳ', score: 6.5, weight: '30%' }
                            ],
                            comment: 'Cần chú ý hơn trong phần bài tập vật lý ứng dụng.',
                            formula: 'Điểm tổng kết = (Chuyên cần × 0.1) + (Giữa kỳ × 0.25) + (Bài tập × 0.15) + (Thực hành × 0.2) + (Cuối kỳ × 0.3)'
                        }
                    },
                ]
            },
            'hk2-2024': {
                gpa: 3.65,
                cumulativeGpa: 3.55,
                rank: 'Giỏi',
                subjects: [
                    {
                        code: 'INT102', name: 'Cấu trúc Dữ liệu', credits: 3, totalScore: 9.0, grade: 'A',
                        details: {
                            teacher: 'ThS. Nguyễn Văn A',
                            teacherShort: 'NVA',
                            scores: [
                                { name: 'Điểm chuyên cần', score: 9.5, weight: '5%' },
                                { name: 'Điểm giữa kỳ', score: 8.5, weight: '25%' },
                                { name: 'Điểm bài tập về nhà', score: 9.0, weight: '20%' },
                                { name: 'Điểm thực hành', score: 9.0, weight: '20%' },
                                { name: 'Điểm cuối kỳ', score: 9.0, weight: '30%' }
                            ],
                            comment: 'Kết quả xuất sắc, kiến thức vững vàng.',
                            formula: 'Điểm tổng kết = (Chuyên cần × 0.05) + (Giữa kỳ × 0.25) + (Bài tập × 0.2) + (Thực hành × 0.2) + (Cuối kỳ × 0.3)'
                        }
                    },
                ]
            },
            'hk1-2023': {
                gpa: 3.20,
                cumulativeGpa: 3.20,
                rank: 'Khá',
                subjects: [
                    {
                        code: 'ENG101', name: 'Tiếng Anh cơ bản', credits: 3, totalScore: 8.0, grade: 'A',
                        details: {
                            teacher: 'Cô giáo D',
                            teacherShort: 'CGD',
                            scores: [
                                { name: 'Điểm chuyên cần', score: 8.5, weight: '10%' },
                                { name: 'Điểm giữa kỳ', score: 8.0, weight: '30%' },
                                { name: 'Điểm thuyết trình', score: 8.0, weight: '20%' },
                                { name: 'Điểm cuối kỳ', score: 8.0, weight: '40%' }
                            ],
                            comment: 'Học sinh tích cực và có tiến bộ rõ rệt.',
                            formula: 'Điểm tổng kết = (Chuyên cần × 0.1) + (Giữa kỳ × 0.3) + (Thuyết trình × 0.2) + (Cuối kỳ × 0.4)'
                        }
                    },
                ]
            },
        };

        // DOM elements
        const pageTitleEl = document.getElementById('page-title');
        const pageSubtitleEl = document.getElementById('page-subtitle');
        const subjectView = document.getElementById('subject-view');
        const backBtn = document.getElementById('back-btn');
        const subjectTitleEl = document.getElementById('subject-title');
        const subjectInfoEl = document.getElementById('subject-info');
        const subjectGradeBadge = document.getElementById('subject-grade-badge');
        const subjectScoresTableBody = document.getElementById('subject-scores-table-body');
        const totalScoreEl = document.getElementById('total-score');
        const scoreFormulaEl = document.getElementById('score-formula');
        const teacherCommentEl = document.getElementById('teacher-comment');
        const teacherNameEl = document.getElementById('teacher-name');
        const teacherAvatarEl = document.getElementById('teacher-avatar');
        
        // Chart variable
        let scoreChart = null;

        // Functions
        function renderSubjectView(semesterId, subjectCode) {
            const semesterData = gradeData[semesterId];
            const subject = semesterData.subjects.find(s => s.code === subjectCode);
            if (!subject) return;
            
            // Update page header
            pageTitleEl.textContent = 'Kết quả môn học';
            pageSubtitleEl.textContent = `Thông tin chi tiết về điểm số của môn ${subject.name}.`;

            subjectTitleEl.textContent = subject.name;
            subjectInfoEl.innerHTML = `
                Mã môn: <span class="font-semibold">${subject.code}</span> | 
                Số tín chỉ: <span class="font-semibold">${subject.credits}</span> | 
                Giảng viên: <span class="font-semibold">${subject.details.teacher}</span>
            `;

            // Set grade badge with appropriate color
            subjectGradeBadge.textContent = `Điểm ${subject.grade}`;
            subjectGradeBadge.className = `mt-4 md:mt-0 px-4 py-2 rounded-full text-white font-bold text-lg grade-${subject.grade.charAt(0)}`;

            subjectScoresTableBody.innerHTML = '';
            subject.details.scores.forEach(score => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-5 py-3 border-b border-gray-200 text-sm">${score.name}</td>
                    <td class="px-5 py-3 border-b border-gray-200 text-sm text-teal-600 font-bold">${score.score.toFixed(1)}</td>
                    <td class="px-5 py-3 border-b border-gray-200 text-sm">${score.weight}</td>
                `;
                subjectScoresTableBody.appendChild(row);
            });

            totalScoreEl.textContent = subject.totalScore.toFixed(1);
            scoreFormulaEl.textContent = subject.details.formula;
            teacherCommentEl.textContent = subject.details.comment;
            teacherNameEl.textContent = subject.details.teacher;
            teacherAvatarEl.textContent = subject.details.teacherShort;

            // Render chart
            renderScoreChart(subject);

            subjectView.classList.remove('hidden');
        }

        function renderScoreChart(subject) {
            const ctx = document.getElementById('score-chart').getContext('2d');
            
            // Destroy previous chart if exists
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            const labels = subject.details.scores.map(score => score.name);
            const data = subject.details.scores.map(score => score.score);
            const backgroundColors = [
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 205, 86, 0.8)'
            ];

            scoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm số',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Get subject code and semester from URL parameters (simulated)
            const urlParams = new URLSearchParams(window.location.search);
            const semesterId = urlParams.get('semester') || 'hk1-2024';
            const subjectCode = urlParams.get('subject') || 'INT101';
            
            renderSubjectView(semesterId, subjectCode);
        });

        backBtn.addEventListener('click', () => {
            // In a real application, this would navigate back to the grades page
            window.history.back();
        });

        document.getElementById('logoutBtn').addEventListener('click', function(event) {
            event.preventDefault();
            console.log('Đăng xuất thành công. Chuyển hướng về trang đăng nhập.');
            alert('Đăng xuất thành công. Chuyển hướng về trang đăng nhập.');
        });
        
        // Mobile menu toggle
        document.getElementById('mobile-menu-btn').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
        
        // Chatbot logic
        const chatbotIcon = document.getElementById('chatbot-icon');
        const chatbotWindow = document.getElementById('chatbot-window');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContent = document.getElementById('chat-content');

        chatbotIcon.addEventListener('click', () => {
            chatbotWindow.classList.toggle('hidden');
        });

        closeChatBtn.addEventListener('click', () => {
            chatbotWindow.classList.add('hidden');
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            const userBubble = document.createElement('div');
            userBubble.className = 'flex justify-end mb-2';
            userBubble.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs">${userMessage}</div>`;
            chatContent.appendChild(userBubble);
            chatInput.value = '';
            chatContent.scrollTop = chatContent.scrollHeight;

            // Simulate AI response based on user message
            setTimeout(() => {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'flex justify-start mb-2';
                
                let responseText = "Tôi có thể giải đáp các thắc mắc về điểm số và cách tính điểm. Bạn có câu hỏi cụ thể nào không?";
                
                if (userMessage.toLowerCase().includes('điểm') && userMessage.toLowerCase().includes('tính')) {
                    responseText = "Điểm tổng kết môn học được tính dựa trên các điểm thành phần nhân với trọng số tương ứng. Bạn có thể xem công thức tính điểm chi tiết ở phần thông tin môn học.";
                } else if (userMessage.toLowerCase().includes('xếp loại')) {
                    responseText = "Xếp loại học tập dựa trên thang điểm 4: Xuất sắc (3.60-4.00), Giỏi (3.20-3.59), Khá (2.50-3.19), Trung bình (2.00-2.49), Yếu (dưới 2.00).";
                } else if (userMessage.toLowerCase().includes('cải thiện')) {
                    responseText = "Để cải thiện điểm số, bạn nên tham gia đầy đủ các buổi học, hoàn thành bài tập đúng hạn, và ôn tập thường xuyên. Hãy trao đổi với giảng viên để nhận được góp ý cụ thể hơn.";
                }
                
                aiBubble.innerHTML = `<div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">${responseText}</div>`;
                chatContent.appendChild(aiBubble);
                chatContent.scrollTop = chatContent.scrollHeight;
            }, 1000);
        });
    </script>
</body>
</html>